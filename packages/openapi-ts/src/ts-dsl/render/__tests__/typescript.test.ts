import type { RenderContext } from '@hey-api/codegen-core';
import { Project } from '@hey-api/codegen-core';
import ts from 'typescript';
import { describe, expect, it } from 'vitest';

import { TypeScriptRenderer } from '../typescript';
import type { ModuleExport, ModuleImport } from '../utils';

describe('TypeScriptRenderer', () => {
  const renderer = new TypeScriptRenderer();

  const mockFile = (overrides: any = {}) => ({
    exports: [],
    imports: [],
    language: 'typescript',
    nodes: [],
    ...overrides,
  });

  const mockCtx = (
    fileOverrides = {},
    projectOverrides = {},
  ): RenderContext => ({
    astContext: {
      getAccess(node) {
        return node;
      },
    },
    file: mockFile(fileOverrides),
    project: new Project({
      root: '/root',
      ...projectOverrides,
    }),
  });

  it('supports() returns true only for typescript files', () => {
    expect(renderer.supports(mockCtx({ language: 'typescript' }))).toBe(true);
    expect(renderer.supports(mockCtx({ language: 'javascript' }))).toBe(false);
  });

  it('render() produces header even with empty file', () => {
    const ctx = mockCtx();
    const result = renderer.render(ctx);
    expect(result).toContain(
      '// This file is auto-generated by @hey-api/openapi-ts',
    );
  });

  it('renderImport() generates named and namespace imports correctly', () => {
    const ctx = mockCtx();
    const group: ModuleImport = {
      imports: [
        {
          isTypeOnly: false,
          kind: 'named',
          localName: 'A',
          sourceName: 'A',
        },
      ],
      isTypeOnly: false,
      modulePath: 'foo',
      namespaceImport: undefined,
    };
    const node = renderer['renderImport'](ctx, group);
    expect(ts.isImportDeclaration(node)).toBe(true);
  });

  it('renderExport() generates named and namespace exports correctly', () => {
    const ctx = mockCtx();
    const group: ModuleExport = {
      canExportAll: false,
      exports: [
        {
          exportedName: 'B',
          isTypeOnly: false,
          kind: 'named',
          sourceName: 'B',
        },
      ],
      isTypeOnly: false,
      modulePath: 'bar',
      namespaceExport: undefined,
    };
    const node = renderer['renderExport'](ctx, group);
    expect(ts.isExportDeclaration(node)).toBe(true);
  });
});
