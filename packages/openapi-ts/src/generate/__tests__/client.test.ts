import path from 'node:path';

/**
 * Replicates the outputHeaderToPrefix logic from generate/client.ts for testing.
 */
function outputHeaderToPrefix(header: unknown): string {
  if (header == null || typeof header === 'function') return '';
  const lines =
    typeof header === 'string'
      ? header.split(/\r?\n/)
      : (header as string[]).flatMap((line) => line.split(/\r?\n/));
  const content = lines.join('\n');
  return content ? `${content}\n\n` : '';
}

describe('outputHeaderToPrefix logic', () => {
  it('returns default comment for string header', () => {
    const result = outputHeaderToPrefix('// This file is auto-generated by @hey-api/openapi-ts');
    expect(result).toBe('// This file is auto-generated by @hey-api/openapi-ts\n\n');
  });

  it('returns joined lines for array header', () => {
    const result = outputHeaderToPrefix([
      '// This file is auto-generated by @hey-api/openapi-ts',
      '// @ts-nocheck',
    ]);
    expect(result).toBe(
      '// This file is auto-generated by @hey-api/openapi-ts\n// @ts-nocheck\n\n',
    );
  });

  it('returns empty string for null header', () => {
    expect(outputHeaderToPrefix(null)).toBe('');
  });

  it('returns empty string for undefined header', () => {
    expect(outputHeaderToPrefix(undefined)).toBe('');
  });

  it('returns empty string for function header', () => {
    expect(outputHeaderToPrefix(() => '// dynamic')).toBe('');
  });

  it('handles string with embedded newlines', () => {
    const result = outputHeaderToPrefix('// line1\n// line2');
    expect(result).toBe('// line1\n// line2\n\n');
  });
});

describe('isDevMode logic', () => {
  const scenarios: ReadonlyArray<{
    description: string;
    expected: boolean;
    mockPath: string;
  }> = [
    {
      description: 'returns true in dev mode (src/generate)',
      expected: true,
      mockPath: ['', 'home', 'user', 'packages', 'openapi-ts', 'src', 'generate'].join(path.sep),
    },
    {
      description: 'returns false in prod mode (dist/generate)',
      expected: false,
      mockPath: ['', 'home', 'user', 'packages', 'openapi-ts', 'dist', 'generate'].join(path.sep),
    },
    {
      description: 'returns false when path contains /src/ but not in correct position',
      expected: false,
      mockPath: [
        '',
        'home',
        'user',
        'src',
        'project',
        'node_modules',
        '@hey-api',
        'openapi-ts',
        'dist',
        'generate',
      ].join(path.sep),
    },
    {
      description: 'returns false when src is in project path (pnpm case from issue)',
      expected: false,
      mockPath: [
        '',
        'home',
        'user',
        'src',
        'thcdb',
        'worktree',
        'schema-gen',
        'web',
        'node_modules',
        '.pnpm',
        '@hey-api+openapi-ts@0.91.1',
        'node_modules',
        '@hey-api',
        'openapi-ts',
        'dist',
        'generate',
      ].join(path.sep),
    },
    {
      description:
        'returns false when src is in project path with plugins path (exact error from issue)',
      expected: false,
      mockPath: [
        '',
        'home',
        'user',
        'src',
        'thcdb',
        'worktree',
        'schema-gen',
        'web',
        'node_modules',
        '.pnpm',
        '@hey-api+openapi-ts@0.91.1_magicast@0.5.1_typescript@5.9.3',
        'node_modules',
        '@hey-api',
        'openapi-ts',
        'plugins',
        '@hey-api',
        'client-core',
        'bundle',
      ].join(path.sep),
    },
    {
      description: 'returns true only when ending with src/generate',
      expected: true,
      mockPath: [
        '',
        'home',
        'user',
        'src',
        'backup',
        'packages',
        'openapi-ts',
        'src',
        'generate',
      ].join(path.sep),
    },
    {
      description: 'returns false when not ending with generate',
      expected: false,
      mockPath: ['', 'home', 'user', 'packages', 'openapi-ts', 'src', 'plugins'].join(path.sep),
    },
    {
      description: 'returns false when src exists but dist is later',
      expected: false,
      mockPath: ['', 'home', 'user', 'src', 'project', 'openapi-ts', 'dist', 'generate'].join(
        path.sep,
      ),
    },
  ];

  it.each(scenarios)('$description', ({ expected, mockPath }) => {
    // Test the isDevMode logic
    const normalized = mockPath.split(path.sep);
    const srcIndex = normalized.lastIndexOf('src');
    const distIndex = normalized.lastIndexOf('dist');

    const result =
      srcIndex !== -1 &&
      srcIndex > distIndex &&
      srcIndex === normalized.length - 2 &&
      normalized[srcIndex + 1] === 'generate';

    expect(result).toBe(expected);
  });
});
